<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Luy·ªán N√≥i Ti·∫øng Anh - V∆∞·ª£t Ch∆∞·ªõng Ng·∫°i V·∫≠t</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f8ff;
            padding: 10px; /* Gi·∫£m padding ƒë·ªÉ game area c√≥ nhi·ªÅu kh√¥ng gian h∆°n */
            line-height: 1.6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden; /* NgƒÉn cu·ªôn ngang */
        }

        .container {
            max-width: 700px; /* TƒÉng chi·ªÅu r·ªông t·ªëi ƒëa */
            width: 100%;
            margin: 10px auto; /* Gi·∫£m l·ªÅ d·ªçc */
            background: #fff;
            padding: 15px; /* Gi·∫£m padding */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box; /* T√≠nh c·∫£ padding v√† border v√†o width */
        }

        h1 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 15px; /* Gi·∫£m margin */
            font-size: 1.8em; /* Gi·∫£m k√≠ch th∆∞·ªõc ti√™u ƒë·ªÅ */
        }

        /* Style cho khu v·ª±c game Canvas */
        #gameCanvas {
            border: 2px solid #007bff;
            background-color: #87ceeb; /* M√†u n·ªÅn tr·ªùi */
            display: block; /* Lo·∫°i b·ªè kho·∫£ng tr·∫Øng d∆∞·ªõi canvas */
            margin: 10px auto; /* CƒÉn gi·ªØa canvas */
            width: 100%; /* Canvas s·∫Ω chi·∫øm to√†n b·ªô chi·ªÅu r·ªông container */
            max-width: 680px; /* Chi·ªÅu r·ªông t·ªëi ƒëa cho canvas */
            height: 300px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho canvas */
        }

        .game-info {
            margin: 10px 0;
            font-size: 1em;
            color: #555;
        }

        .question {
            margin: 15px 0 10px 0; /* Gi·∫£m l·ªÅ */
            font-size: 1.1em; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
            font-weight: bold;
            color: #0056b3; /* M√†u ch·ªØ c√¢u h·ªèi */
        }

        .target-sentence {
            margin-top: 5px;
            font-size: 0.95em;
            color: #007bff;
            font-style: italic;
        }

        .answer-box {
            background: #eef;
            padding: 10px; /* Gi·∫£m padding */
            border-radius: 5px;
            margin-top: 10px;
            min-height: 1.2em; /* Gi·∫£m chi·ªÅu cao t·ªëi thi·ªÉu */
            text-align: left;
            word-wrap: break-word;
            border: 1px solid #cce;
            font-size: 0.95em; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
        }

        button {
            margin: 8px 4px; /* Gi·∫£m l·ªÅ v√† kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            padding: 10px 15px; /* Gi·∫£m padding */
            font-size: 0.95em; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        button:active {
            transform: scale(0.98);
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .feedback { /* ƒê·ªïi t√™n t·ª´ .result sang .feedback */
            background: #e0ffe0;
            padding: 10px; /* Gi·∫£m padding */
            margin-top: 10px;
            border-radius: 5px;
            text-align: left;
            border: 1px solid #a3e0a3;
            font-weight: bold;
            font-size: 0.95em; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
        }

        .results-display {
            background: #fff8e1;
            padding: 15px; /* Gi·∫£m padding */
            margin-top: 15px;
            border-radius: 8px;
            text-align: left;
            border: 1px solid #ffecb3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.95em; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
        }

        .results-display h3 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 10px; /* Gi·∫£m margin */
            border-bottom: 1px solid #eee;
            padding-bottom: 8px; /* Gi·∫£m padding */
            font-size: 1.3em; /* Gi·∫£m k√≠ch th∆∞·ªõc ti√™u ƒë·ªÅ */
        }

        .results-display p {
            margin-bottom: 8px; /* Gi·∫£m margin */
            padding-bottom: 8px; /* Gi·∫£m padding */
            border-bottom: 1px dashed #eee;
        }
        .results-display p:last-child {
            border-bottom: none;
        }

        .results-display strong {
            color: #007bff;
        }

        .results-display em {
            color: #555;
        }

        .results-display button {
            display: block;
            margin: 15px auto 8px auto; /* Gi·∫£m l·ªÅ */
            background-color: #28a745;
        }
        .results-display button:hover {
            background-color: #218838;
        }

        #copyFeedback {
            margin-top: 10px; /* Gi·∫£m margin */
            font-size: 0.9em; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 8px; /* Gi·∫£m padding */
            border-radius: 5px;
            text-align: center;
        }
        #copyFeedback a {
            color: #0056b3;
            font-weight: bold;
            text-decoration: underline;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 10px;
                margin: 5px auto;
            }
            h1 {
                font-size: 1.5em;
                margin-bottom: 10px;
            }
            #gameCanvas {
                height: 250px; /* Gi·∫£m chi·ªÅu cao canvas tr√™n m√†n h√¨nh nh·ªè */
            }
            button {
                padding: 8px 12px;
                font-size: 0.9em;
                margin: 5px 3px;
            }
            .question {
                font-size: 1em;
                margin: 10px 0;
            }
            .answer-box, .feedback, .results-display {
                font-size: 0.9em;
                padding: 8px;
            }
            .results-display h3 {
                font-size: 1.2em;
            }
        }

    </style>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>
    <div class="container">
        <h1>Luy·ªán N√≥i Ti·∫øng Anh - V∆∞·ª£t Ch∆∞·ªõng Ng·∫°i V·∫≠t</h1>

        <div class="game-info">
            Ch∆∞·ªõng ng·∫°i v·∫≠t ƒë√£ v∆∞·ª£t qua: <span id="obstaclesCleared">0</span> / T·ªïng s·ªë: <span id="totalObstacles">0</span>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="questionArea" class="question">B·∫•m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ nghe c√¢u h·ªèi.</div>
        <div id="targetSentenceArea" class="target-sentence" style="display: none;"></div>

        <div>
            <button onclick="speakQuestion()" id="startButton">üîä B·∫Øt ƒë·∫ßu</button>
            <button onclick="startRecognition()" id="answerButton">üé§ Tr·∫£ l·ªùi</button>
        </div>
        <div id="transcript" class="answer-box"></div>
        <div id="feedback" class="feedback" style="display: none;"></div>

        <div>
            <button onclick="nextQuestion()" id="nextButton">‚û°Ô∏è Ch∆∞·ªõng ng·∫°i v·∫≠t ti·∫øp theo</button>
            <button onclick="displayResults()" id="viewResultsButton">üìä Xem k·∫øt qu·∫£</button>
        </div>

        <div id="resultsDisplayArea" class="results-display" style="display: none;"></div>
    </div>

    <script>
        // --- C·∫•u h√¨nh Game v√† C√¢u h·ªèi ---
        const questions = [
            // C√°c c√¢u h·ªèi v·ªÅ ƒë·ªì ƒÉn - ƒê√£ th√™m foodName v√† correctAnswer
            { question: "What do you like to eat?", foodName: "apples", correctAnswer: "I like to eat apples." }, // T√°o
            { question: "What do you like to eat?", foodName: "bananas", correctAnswer: "I like to eat bananas." }, // Chu·ªëi
            { question: "What do you like to eat?", foodName: "oranges", correctAnswer: "I like to eat oranges." }, // Cam
            { question: "What do you like to eat?", foodName: "strawberries", correctAnswer: "I like to eat strawberries." }, // D√¢u t√¢y
            { question: "What do you like to eat?", foodName: "watermelon", correctAnswer: "I like to eat watermelon." }, // D∆∞a h·∫•u
            { question: "What do you like to eat?", foodName: "mangoes", correctAnswer: "I like to eat mangoes." }, // Xo√†i
            { question: "What do you like to eat?", foodName: "pineapples", correctAnswer: "I like to eat pineapples." }, // D·ª©a
            { question: "What do you like to eat?", foodName: "cherries", correctAnswer: "I like to eat cherries." }, // Anh ƒë√†o
            { question: "What do you like to eat?", foodName: "broccoli", correctAnswer: "I like to eat broccoli." }, // B√¥ng c·∫£i xanh
            { question: "What do you like to eat?", foodName: "carrots", correctAnswer: "I like to eat carrots." }, // C√† r·ªët
            { question: "What do you like to eat?", foodName: "corn", correctAnswer: "I like to eat corn." }, // Ng√¥
            { question: "What do you like to eat?", foodName: "rice", correctAnswer: "I like to eat rice." }, // G·∫°o
            { question: "What do you like to eat?", foodName: "noodles", correctAnswer: "I like to eat noodles." }, // M√¨
            { question: "What do you like to eat?", foodName: "chicken", correctAnswer: "I like to eat chicken." }, // Th·ªãt g√†
            { question: "What do you like to eat?", foodName: "beef", correctAnswer: "I like to eat beef." }, // Th·ªãt b√≤
            { question: "What do you like to eat?", foodName: "fish", correctAnswer: "I like to eat fish." }, // C√°
            { question: "What do you like to eat?", foodName: "eggs", correctAnswer: "I like to eat eggs." }, // Tr·ª©ng
            { question: "What do you like to eat?", foodName: "pizza", correctAnswer: "I like to eat pizza." }, // B√°nh pizza
            { question: "What do you like to eat?", foodName: "a hamburger", correctAnswer: "I like to eat a hamburger." }, // B√°nh hamburger
            { question: "What do you like to eat?", foodName: "ice cream", correctAnswer: "I like to eat ice cream." }  // Kem
        ];

        let currentIndex = 0; // Theo d√µi ch·ªâ s·ªë c√¢u h·ªèi hi·ªán t·∫°i
        let studentAnswers = new Array(questions.length).fill(""); // L∆∞u tr·ªØ c√¢u tr·∫£ l·ªùi c·ªßa h·ªçc sinh
        let obstaclesClearedCount = 0; // S·ªë ch∆∞·ªõng ng·∫°i v·∫≠t ƒë√£ v∆∞·ª£t qua

        // --- DOM Elements ---
        const questionArea = document.getElementById("questionArea");
        const targetSentenceArea = document.getElementById("targetSentenceArea");
        const transcriptDiv = document.getElementById("transcript");
        const feedbackDiv = document.getElementById("feedback");
        const resultsDisplayArea = document.getElementById("resultsDisplayArea");
        const startButton = document.getElementById("startButton");
        const answerButton = document.getElementById("answerButton");
        const nextButton = document.getElementById("nextButton");
        const viewResultsButton = document.getElementById("viewResultsButton");
        const obstaclesClearedSpan = document.getElementById("obstaclesCleared");
        const totalObstaclesSpan = document.getElementById("totalObstacles");


        // --- Canvas Setup ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // K√≠ch th∆∞·ªõc canvas (s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh b·ªüi CSS responsive)
        let canvasWidth; // Khai b√°o
        let canvasHeight; // Khai b√°o

        // --- Game Variables ---
        // Khai b√°o v√† kh·ªüi t·∫°o c√°c bi·∫øn game ·ªü ƒë√¢y
        const groundHeight = 40; // Chi·ªÅu cao m·∫∑t ƒë·∫•t
        let groundY; // V·ªã tr√≠ Y c·ªßa m·∫∑t ƒë·∫•t (s·∫Ω ƒë∆∞·ª£c t√≠nh trong resizeCanvas)
        const playerSize = 30; // K√≠ch th∆∞·ªõc nh√¢n v·∫≠t (cho v√πng va ch·∫°m/v·ªã tr√≠)
        const playerColor = "#d9534f"; // M√†u nh√¢n v·∫≠t (ƒê·ªè)
        const playerShapeSize = 30; // K√≠ch th∆∞·ªõc h√¨nh v·∫Ω nh√¢n v·∫≠t
        let playerY; // V·ªã tr√≠ Y hi·ªán t·∫°i c·ªßa ng∆∞·ªùi ch∆°i (s·∫Ω ƒë∆∞·ª£c t√≠nh trong resizeCanvas)
        let playerGroundY; // V·ªã tr√≠ Y khi ng∆∞·ªùi ch∆°i ƒë·ª©ng tr√™n m·∫∑t ƒë·∫•t (s·∫Ω ƒë∆∞·ª£c t√≠nh trong resizeCanvas)
        const playerX = 50; // V·ªã tr√≠ X c·ªë ƒë·ªãnh c·ªßa ng∆∞·ªùi ch∆°i tr√™n m√†n h√¨nh

        const obstacleWidth = 40; // Chi·ªÅu r·ªông ch∆∞·ªõng ng·∫°i v·∫≠t
        const obstacleHeight = 60; // Chi·ªÅu cao ch∆∞·ªõng ng·∫°i v·∫≠t
        const obstacleColor = "#8b4513"; // M√†u ch∆∞·ªõng ng·∫°i v·∫≠t (N√¢u ƒë·∫•t) - Kh√¥ng d√πng tr·ª±c ti·∫øp n·ªØa
        const obstacleSpacing = 150; // Kho·∫£ng c√°ch gi·ªØa c√°c ch∆∞·ªõng ng·∫°i v·∫≠t
        const initialObstacleOffset = 200; // Kho·∫£ng c√°ch ban ƒë·∫ßu c·ªßa ch∆∞·ªõng ng·∫°i v·∫≠t ƒë·∫ßu ti√™n t·ª´ l·ªÅ tr√°i
        const obstacleEmojiSize = 30; // K√≠ch th∆∞·ªõc emoji ch∆∞·ªõng ng·∫°i v·∫≠t


        // Bi·∫øn cho hi·ªáu ·ª©ng v·∫≠t l√Ω
        let velocityY = 0; // V·∫≠n t·ªëc theo tr·ª•c Y
        const gravity = 0.8; // L·ª±c h·∫•p d·∫´n (tƒÉng d·∫ßn v·∫≠n t·ªëc Y)
        const jumpStrength = -15; // L·ª±c nh·∫£y ban ƒë·∫ßu (v·∫≠n t·ªëc Y √¢m ƒë·ªÉ ƒëi l√™n)
        let isJumping = false; // Tr·∫°ng th√°i nh·∫£y

        let obstacles = []; // M·∫£ng l∆∞u tr·ªØ v·ªã tr√≠ v√† tr·∫°ng th√°i c·ªßa ch∆∞·ªõng ng·∫°i v·∫≠t
        let gameSpeed = 3; // T·ªëc ƒë·ªô cu·ªôn m√†n h√¨nh (khi tr·∫£ l·ªùi ƒë√∫ng) - TƒÉng t·ªëc ƒë·ªô m·ªôt ch√∫t
        let isMoving = false; // Tr·∫°ng th√°i di chuy·ªÉn ngang c·ªßa m√†n h√¨nh
        let moveDistance = 0; // Kho·∫£ng c√°ch c·∫ßn di chuy·ªÉn ngang

        // --- Audio Setup (using Tone.js) ---
        let jumpSynth; // B·ªô t·ªïng h·ª£p √¢m thanh cho ti·∫øng nh·∫£y

        // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc canvas khi c·ª≠a s·ªï thay ƒë·ªïi k√≠ch th∆∞·ªõc
        const resizeCanvas = () => {
            canvasWidth = canvas.clientWidth;
            canvasHeight = canvas.clientHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            // Khi resize, c·∫ßn c·∫≠p nh·∫≠t v·ªã tr√≠ groundY v√† playerGroundY
            groundY = canvasHeight - groundHeight;
            playerGroundY = canvasHeight - groundHeight - playerSize;
            // ƒêi·ªÅu ch·ªânh l·∫°i v·ªã tr√≠ Y c·ªßa player n·∫øu ƒëang ·ªü tr√™n m·∫∑t ƒë·∫•t
            if (!isJumping) {
                 playerY = playerGroundY;
            }
            // C·∫ßn kh·ªüi t·∫°o l·∫°i v·ªã tr√≠ ch∆∞·ªõng ng·∫°i v·∫≠t khi resize ƒë·ªÉ ch√∫ng xu·∫•t hi·ªán ƒë√∫ng
            initializeObstacles(); // Kh·ªüi t·∫°o l·∫°i ch∆∞·ªõng ng·∫°i v·∫≠t
            drawGame(); // V·∫Ω l·∫°i game khi k√≠ch th∆∞·ªõc thay ƒë·ªïi
        };
        window.addEventListener('resize', resizeCanvas);


        // Kh·ªüi t·∫°o ch∆∞·ªõng ng·∫°i v·∫≠t
        function initializeObstacles() {
            obstacles = []; // Reset m·∫£ng ch∆∞·ªõng ng·∫°i v·∫≠t
            for (let i = 0; i < questions.length; i++) {
                obstacles.push({
                    // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ x ban ƒë·∫ßu ƒë·ªÉ ch√∫ng hi·ªÉn th·ªã ngay tr√™n m√†n h√¨nh
                    x: initialObstacleOffset + i * obstacleSpacing,
                    y: canvasHeight - groundHeight - obstacleHeight, // V·ªã tr√≠ y c·ªßa h√¨nh kh·ªëi ch∆∞·ªõng ng·∫°i v·∫≠t (kh√¥ng d√πng n·ªØa)
                    cleared: false, // Tr·∫°ng th√°i ƒë√£ v∆∞·ª£t qua hay ch∆∞a
                    foodName: questions[i].foodName, // L∆∞u t√™n m√≥n ƒÉn v√†o ch∆∞·ªõng ng·∫°i v·∫≠t
                    // V·ªã tr√≠ y cho emoji/text (cƒÉn gi·ªØa chi·ªÅu cao obstacleHeight)
                    emojiY: canvasHeight - groundHeight - obstacleHeight / 2
                });
            }
        }

        // --- Mapping foodName to Emoji ---
        function getFoodEmoji(foodName) {
            switch (foodName) {
                case "apples": return "üçé";
                case "bananas": return "üçå";
                case "oranges": return "üçä";
                case "strawberries": return "üçì";
                case "watermelon": return "üçâ";
                case "mangoes": return "ü•≠";
                case "pineapples": return "üçç";
                case "cherries": return "üçí";
                case "broccoli": return "ü•¶";
                case "carrots": return "ü•ï";
                case "corn": return "üåΩ";
                case "rice": return "üçö";
                case "noodles": return "üçú";
                case "chicken": return "üçó";
                case "beef": return "ü•©";
                case "fish": return "üêü"; // Ho·∫∑c üê†
                case "eggs": return "ü•ö";
                case "pizza": return "üçï";
                case "a hamburger": return "üçî";
                case "ice cream": return "üç¶";
                default: return "‚ùì"; // Emoji m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng t√¨m th·∫•y
            }
        }


        // --- Drawing Functions ---
        function drawGround() {
            ctx.fillStyle = "#a0522d"; // M√†u n√¢u ƒë·∫•t
            ctx.fillRect(0, groundY, canvasWidth, groundHeight);
        }

        function drawPlayer() {
            ctx.fillStyle = playerColor; // M√†u ƒë·ªè cho nh√¢n v·∫≠t

            // V·∫Ω h√¨nh nh√¢n v·∫≠t ƒë∆°n gi·∫£n h∆∞·ªõng v·ªÅ b√™n ph·∫£i
            // V·∫Ω th√¢n
            ctx.fillRect(playerX + playerShapeSize * 0.2, playerY, playerShapeSize * 0.6, playerShapeSize * 0.8);
            // V·∫Ω ƒë·∫ßu
            ctx.beginPath();
            ctx.arc(playerX + playerShapeSize / 2, playerY - playerShapeSize * 0.3, playerShapeSize * 0.3, 0, Math.PI * 2);
            ctx.fill();
            // V·∫Ω ch√¢n (m√¥ ph·ªèng ƒëang ch·∫°y)
            ctx.fillRect(playerX + playerShapeSize * 0.1, playerY + playerShapeSize * 0.8, playerShapeSize * 0.3, playerShapeSize * 0.2);
            ctx.fillRect(playerX + playerShapeSize * 0.6, playerY + playerShapeSize * 0.8, playerShapeSize * 0.3, playerShapeSize * 0.2);
            // V·∫Ω tay (m√¥ ph·ªèng ƒëang ch·∫°y)
            ctx.fillRect(playerX, playerY + playerShapeSize * 0.2, playerShapeSize * 0.3, playerShapeSize * 0.15);
            ctx.fillRect(playerX + playerShapeSize * 0.7, playerY + playerShapeSize * 0.4, playerShapeSize * 0.3, playerShapeSize * 0.15);

            // C√≥ th·ªÉ th√™m hi·ªáu ·ª©ng khi nh·∫£y (v√≠ d·ª•: thay ƒë·ªïi m√†u ho·∫∑c h√¨nh d√°ng nh·∫π)
            if (isJumping) {
                 // V√≠ d·ª•: V·∫Ω th√™m m·ªôt v√≤ng s√°ng nh·ªè quanh nh√¢n v·∫≠t khi nh·∫£y
                 ctx.strokeStyle = "yellow";
                 ctx.lineWidth = 2;
                 ctx.beginPath();
                 ctx.arc(playerX + playerSize / 2, playerY + playerSize / 2, playerSize * 0.8, 0, Math.PI * 2);
                 ctx.stroke();
            }
        }


        function drawObstacles() {
            obstacles.forEach((obstacle, index) => {
                const foodEmoji = getFoodEmoji(obstacle.foodName);

                ctx.globalAlpha = obstacle.cleared ? 0.3 : 1; // Gi·∫£m opacity n·∫øu ƒë√£ v∆∞·ª£t qua

                // V·∫Ω Emoji m√≥n ƒÉn
                ctx.font = `${obstacleEmojiSize}px Arial`; // S·ª≠ d·ª•ng font Arial cho emoji
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                // V·ªã tr√≠ v·∫Ω emoji (cƒÉn gi·ªØa chi·ªÅu r·ªông obstacleWidth v√† chi·ªÅu cao obstacleHeight)
                const emojiDrawX = obstacle.x + obstacleWidth / 2;
                const emojiDrawY = obstacle.emojiY; // S·ª≠ d·ª•ng v·ªã tr√≠ y ƒë√£ t√≠nh tr∆∞·ªõc

                ctx.fillText(foodEmoji, emojiDrawX, emojiDrawY);

                // V·∫Ω t√™n m√≥n ƒÉn (t√πy ch·ªçn, c√≥ th·ªÉ b·ªè ƒëi n·∫øu mu·ªën ch·ªâ d√πng emoji)
                ctx.fillStyle = "black"; // M√†u ch·ªØ ƒëen
                ctx.font = "10px Arial"; // K√≠ch th∆∞·ªõc ch·ªØ nh·ªè h∆°n
                ctx.textAlign = "center";
                ctx.textBaseline = "top"; // CƒÉn tr√™n ƒë·ªÉ v·∫Ω d∆∞·ªõi emoji
                ctx.fillText(obstacle.foodName, emojiDrawX, obstacle.emojiY + obstacleEmojiSize / 2 + 5); // V·∫Ω d∆∞·ªõi emoji

                 // V·∫Ω s·ªë th·ª© t·ª± ch∆∞·ªõng ng·∫°i v·∫≠t (t√πy ch·ªçn, c√≥ th·ªÉ b·ªè ƒëi)
                 ctx.fillStyle = "rgba(0,0,0,0.5)"; // M√†u x√°m m·ªù cho s·ªë th·ª© t·ª±
                 ctx.font = "10px Arial";
                 ctx.fillText(index + 1, obstacle.x + obstacleWidth / 2, obstacle.emojiY - obstacleEmojiSize / 2 - 5); // V·∫Ω tr√™n emoji

                ctx.globalAlpha = 1; // Reset opacity
            });
        }

        function drawGame() {
            // X√≥a to√†n b·ªô canvas
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // V·∫Ω c√°c y·∫øu t·ªë game
            drawGround();
            drawObstacles(); // V·∫Ω ch∆∞·ªõng ng·∫°i v·∫≠t tr∆∞·ªõc nh√¢n v·∫≠t
            drawPlayer(); // V·∫Ω nh√¢n v·∫≠t sau ƒë·ªÉ n√≥ n·∫±m tr√™n ch∆∞·ªõng ng·∫°i v·∫≠t (khi nh·∫£y)

            // Hi·ªÉn th·ªã th√¥ng b√°o "R·∫•t t·ªët!" ho·∫∑c "Ch∆∞a ƒë√∫ng!" tr√™n canvas (t√πy ch·ªçn)
            // C√≥ th·ªÉ th√™m logic ƒë·ªÉ hi·ªÉn th·ªã t·∫°m th·ªùi khi c√≥ ph·∫£n h·ªìi
        }

        // --- Game Loop / Animation ---
        function gameLoop() {
            // C·∫≠p nh·∫≠t v·ªã tr√≠ nh√¢n v·∫≠t theo hi·ªáu ·ª©ng v·∫≠t l√Ω
            if (isJumping || playerY < playerGroundY) { // √Åp d·ª•ng tr·ªçng l·ª±c khi ƒëang nh·∫£y ho·∫∑c ƒëang r∆°i
                velocityY += gravity;
                playerY += velocityY;

                // Ki·ªÉm tra va ch·∫°m v·ªõi m·∫∑t ƒë·∫•t
                if (playerY >= playerGroundY) {
                    playerY = playerGroundY; // ƒê·∫∑t l·∫°i v·ªã tr√≠ tr√™n m·∫∑t ƒë·∫•t
                    velocityY = 0; // D·ª´ng r∆°i
                    isJumping = false; // K·∫øt th√∫c nh·∫£y
                }
            }

            // Di chuy·ªÉn m√†n h√¨nh ngang khi c·∫ßn
            if (isMoving) {
                // Di chuy·ªÉn t·∫•t c·∫£ ch∆∞·ªõng ng·∫°i v·∫≠t sang tr√°i
                obstacles.forEach(obstacle => {
                    obstacle.x -= gameSpeed;
                });
                moveDistance -= gameSpeed;

                // D·ª´ng di chuy·ªÉn khi ƒë√£ ƒëi ƒë·ªß kho·∫£ng c√°ch
                if (moveDistance <= 0) {
                    isMoving = false;
                    moveDistance = 0;
                }
            }

            drawGame(); // V·∫Ω l·∫°i tr·∫°ng th√°i game

            requestAnimationFrame(gameLoop); // L·∫∑p l·∫°i v√≤ng l·∫∑p
        }

        // --- Speech Recognition and Synthesis ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function (event) {
                const transcript = event.results.length > 0 ? event.results[0][0].transcript.trim() : '';
                transcriptDiv.textContent = `C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: ${transcript}`;
                studentAnswers[currentIndex] = transcript;
                provideFeedback(transcript);
                answerButton.disabled = false;
            };

            recognition.onerror = function(event) {
                console.error("L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i:", event.error);
                let errorMessage = `L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i: ${event.error}`;
                if (event.error === 'no-speech') {
                    errorMessage = "Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.";
                } else if (event.error === 'audio-capture') {
                    errorMessage = "L·ªói thu √¢m thanh. Ki·ªÉm tra micro c·ªßa b·∫°n.";
                } else if (event.error === 'not-allowed') {
                    errorMessage = "Quy·ªÅn truy c·∫≠p micro b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.";
                } else {
                     errorMessage = `L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i: ${event.error}. Vui l√≤ng th·ª≠ l·∫°i.`;
                }
                feedbackDiv.textContent = errorMessage;
                feedbackDiv.style.display = 'block';
                feedbackDiv.style.backgroundColor = '#f8d7da'; // M√†u ƒë·ªè nh·∫°t cho l·ªói
                feedbackDiv.style.borderColor = '#f5c6cb';
                speakText("C√≥ l·ªói x·∫£y ra, b·∫°n h√£y th·ª≠ l·∫°i.", 'vi-VN');
                answerButton.disabled = false;
            };

            recognition.onstart = function() {
                answerButton.disabled = true;
                transcriptDiv.textContent = "ƒêang nghe...";
                 feedbackDiv.style.display = 'none'; // ·∫®n ph·∫£n h·ªìi c≈© khi b·∫Øt ƒë·∫ßu nghe
            };

            recognition.onend = function() {
                 answerButton.disabled = false;
                 // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£ n√†o ƒë∆∞·ª£c x·ª≠ l√Ω (v√≠ d·ª•: ng∆∞·ªùi d√πng kh√¥ng n√≥i g√¨)
                 if (transcriptDiv.textContent === "ƒêang nghe...") {
                     transcriptDiv.textContent = "Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i.";
                     feedbackDiv.textContent = "Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. B·∫°n h√£y th·ª≠ l·∫°i nh√©!";
                     feedbackDiv.style.display = 'block';
                     feedbackDiv.style.backgroundColor = '#fff3cd'; // M√†u v√†ng nh·∫°t
                     feedbackDiv.style.borderColor = '#ffeeba';
                     speakText("Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. B·∫°n h√£y th·ª≠ l·∫°i nh√©!", 'vi-VN');
                 }
            };

        } else {
            console.warn("API Nh·∫≠n d·∫°ng gi·ªçng n√≥i kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ trong tr√¨nh duy·ªát n√†y.");
            if (answerButton) {
                answerButton.disabled = true;
                answerButton.textContent = "üé§ API kh√¥ng h·ªó tr·ª£";
            }
            questionArea.textContent = "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i. Vui l√≤ng th·ª≠ tr√¨nh duy·ªát kh√°c (v√≠ d·ª•: Google Chrome).";
        }

        function speakText(text, lang = 'en-US') {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            speechSynthesis.speak(utterance);
        }

        // --- Game Logic and Flow ---
        function speakQuestion() {
            if (currentIndex >= questions.length) {
                questionArea.textContent = "üéâ B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c ch∆∞·ªõng ng·∫°i v·∫≠t!";
                targetSentenceArea.style.display = 'none';
                disableButtonsOnComplete();
                displayResults();
                return;
            }

            const currentQuestionData = questions[currentIndex];
            speakText(currentQuestionData.question, 'en-US');
            questionArea.textContent = `C√¢u h·ªèi ${currentIndex + 1}/${questions.length}: ${currentQuestionData.question}`;

            targetSentenceArea.style.display = 'none';
            if (currentQuestionData.correctAnswer) { // Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi m·ª•c ti√™u n·∫øu c√≥
                targetSentenceArea.textContent = `H√£y ƒë·ªçc: "${currentQuestionData.correctAnswer}"`;
                targetSentenceArea.style.display = 'block';
            }

            transcriptDiv.textContent = "";
            feedbackDiv.textContent = "";
            feedbackDiv.style.display = 'none';
            resultsDisplayArea.style.display = 'none';
            resultsDisplayArea.innerHTML = '';

            startButton.disabled = false;
            answerButton.disabled = !SpeechRecognition;
            nextButton.disabled = false;
            viewResultsButton.disabled = false;
        }

        function startRecognition() {
            if (currentIndex >= questions.length) {
                transcriptDiv.textContent = "B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi.";
                return;
            }
             // Ch·ªâ cho ph√©p tr·∫£ l·ªùi n·∫øu kh√¥ng ƒëang nh·∫£y ho·∫∑c di chuy·ªÉn m√†n h√¨nh
            if (!isJumping && !isMoving) {
                // Kh·ªüi t·∫°o Tone.js context khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c l·∫ßn ƒë·∫ßu
                if (Tone.context.state !== 'running') {
                     Tone.start();
                     console.log('Tone.js context started');
                }
                if (recognition) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("L·ªói khi b·∫Øt ƒë·∫ßu nh·∫≠n d·∫°ng:", e);
                        transcriptDiv.textContent = "Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông micro.";
                        if (e.name === 'NotAllowedError') {
                            transcriptDiv.textContent = "B·∫°n c·∫ßn c·∫•p quy·ªÅn truy c·∫≠p micro.";
                        } else if (e.name === 'InvalidStateError') {
                            console.warn("Recognition ƒëang ch·∫°y, kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu l·∫°i ngay.");
                             feedbackDiv.textContent = "H·ªá th·ªëng ƒëang b·∫≠n, vui l√≤ng th·ª≠ l·∫°i sau √≠t gi√¢y.";
                             feedbackDiv.style.display = 'block';
                             feedbackDiv.style.backgroundColor = '#fff3cd';
                             feedbackDiv.style.borderColor = '#ffeeba';
                        }
                        answerButton.disabled = false;
                    }
                } else {
                    transcriptDiv.textContent = "Nh·∫≠n d·∫°ng gi·ªçng n√≥i kh√¥ng kh·∫£ d·ª•ng.";
                }
            } else {
                 feedbackDiv.textContent = "Vui l√≤ng ƒë·ª£i hi·ªáu ·ª©ng k·∫øt th√∫c tr∆∞·ªõc khi tr·∫£ l·ªùi.";
                 feedbackDiv.style.display = 'block';
                 feedbackDiv.style.backgroundColor = '#fff3cd';
                 feedbackDiv.style.borderColor = '#ffeeba';
            }
        }

        function provideFeedback(answer) {
            feedbackDiv.style.display = 'block';
            const currentQuestionData = questions[currentIndex];
            let comment = "";
            let speakFeedbackText = "";

            if (!answer || answer.trim() === "") {
                comment = "‚ö†Ô∏è Kh√¥ng ph√°t hi·ªán th·∫•y c√¢u tr·∫£ l·ªùi. B·∫°n h√£y ƒë·ªçc l·∫°i nh√©!";
                speakFeedbackText = "B·∫°n h√£y ƒë·ªçc l·∫°i nh√©!";
                feedbackDiv.style.backgroundColor = '#fff3cd'; // M√†u v√†ng nh·∫°t cho c·∫£nh b√°o
                feedbackDiv.style.borderColor = '#ffeeba';
            } else if (currentQuestionData.correctAnswer) {
                const normalize = (text) => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, "").replace(/\s+/g, ' ').trim();
                const normalizedAnswer = normalize(answer);
                const normalizedCorrectAnswer = normalize(currentQuestionData.correctAnswer);

                if (normalizedAnswer === normalizedCorrectAnswer) {
                    comment = "‚úÖ B·∫°n n√≥i r·∫•t t·ªët! B·∫°n ƒë√£ v∆∞·ª£t qua ch∆∞·ªõng ng·∫°i v·∫≠t!";
                    speakFeedbackText = "B·∫°n n√≥i r·∫•t t·ªët!";
                    feedbackDiv.style.backgroundColor = '#d4edda'; // M√†u xanh l√° nh·∫°t cho ƒë√∫ng
                    feedbackDiv.style.borderColor = '#c3e6cb';

                    // Logic v∆∞·ª£t ch∆∞·ªõng ng·∫°i v·∫≠t tr√™n canvas
                    // Ki·ªÉm tra xem ch∆∞·ªõng ng·∫°i v·∫≠t hi·ªán t·∫°i c√≥ t·ªìn t·∫°i v√† ch∆∞a ƒë∆∞·ª£c v∆∞·ª£t qua kh√¥ng
                    if (currentIndex < obstacles.length && obstacles[currentIndex] && !obstacles[currentIndex].cleared) {
                        obstacles[currentIndex].cleared = true;
                        obstaclesClearedCount++;
                        obstaclesClearedSpan.textContent = obstaclesClearedCount;

                        // K√≠ch ho·∫°t hi·ªáu ·ª©ng nh·∫£y v√† di chuy·ªÉn ngang
                        if (!isJumping) { // Ch·ªâ nh·∫£y n·∫øu ƒëang kh√¥ng nh·∫£y
                             isJumping = true;
                             velocityY = jumpStrength; // B·∫Øt ƒë·∫ßu nh·∫£y l√™n
                             // Ph√°t √¢m thanh nh·∫£y m·ªõi
                             if (jumpSynth) {
                                const now = Tone.now();
                                jumpSynth.triggerAttackRelease("C5", "16n", now);
                                jumpSynth.triggerAttackRelease("G5", "16n", now + 0.05); // Play G5 slightly after C5
                                jumpSynth.triggerAttackRelease("C6", "16n", now + 0.1);  // Play C6 slightly after G5
                             }
                        }
                        // K√≠ch ho·∫°t di chuy·ªÉn ngang ngay sau khi tr·∫£ l·ªùi ƒë√∫ng
                        isMoving = true;
                        moveDistance = obstacleSpacing + obstacleWidth; // Kho·∫£ng c√°ch di chuy·ªÉn ngang
                    }

                } else {
                    comment = `‚ùå Ch∆∞a ƒë√∫ng l·∫Øm. B·∫°n h√£y th·ª≠ ƒë·ªçc l·∫°i nh√©! (C√¢u ƒë√∫ng n√™n l√†: "${currentQuestionData.correctAnswer}")`;
                    speakFeedbackText = "B·∫°n h√£y ƒë·ªçc l·∫°i nh√©!";
                    feedbackDiv.style.backgroundColor = '#f8d7da'; // M√†u ƒë·ªè nh·∫°t cho sai
                    feedbackDiv.style.borderColor = '#f5c6cb';
                }
            } else {
                // ƒê·ªëi v·ªõi c√¢u h·ªèi kh√¥ng c√≥ ƒë√°p √°n c·ª• th·ªÉ
                comment = "‚úÖ ƒê√£ ghi l·∫°i c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.";
                feedbackDiv.style.backgroundColor = '#d4edda'; // M√†u xanh l√° nh·∫°t
                feedbackDiv.style.borderColor = '#c3e6cb';
                 // N·∫øu kh√¥ng c√≥ ƒë√°p √°n ƒë√∫ng c·ª• th·ªÉ, coi nh∆∞ v∆∞·ª£t qua ƒë·ªÉ c√≥ th·ªÉ chuy·ªÉn c√¢u
                 // Ki·ªÉm tra xem ch∆∞·ªõng ng·∫°i v·∫≠t hi·ªán t·∫°i c√≥ t·ªìn t·∫°i v√† ch∆∞a ƒë∆∞·ª£c v∆∞·ª£t qua kh√¥ng
                 if (currentIndex < obstacles.length && obstacles[currentIndex] && !obstacles[currentIndex].cleared) {
                    obstacles[currentIndex].cleared = true;
                    obstaclesClearedCount++;
                    obstaclesClearedSpan.textContent = obstaclesClearedCount;
                     // V·∫´n k√≠ch ho·∫°t hi·ªáu ·ª©ng di chuy·ªÉn ngang
                    isMoving = true;
                    moveDistance = obstacleSpacing + obstacleWidth;
                 }
            }
            feedbackDiv.textContent = comment;
            if (speakFeedbackText) {
                speakText(speakFeedbackText, 'vi-VN');
            }
        }

        function nextQuestion() {
            // Ch·ªâ chuy·ªÉn c√¢u h·ªèi n·∫øu ch∆∞·ªõng ng·∫°i v·∫≠t hi·ªán t·∫°i ƒë√£ ƒë∆∞·ª£c v∆∞·ª£t qua V√Ä hi·ªáu ·ª©ng di chuy·ªÉn ƒë√£ d·ª´ng
            // Th√™m ki·ªÉm tra currentIndex h·ª£p l·ªá v√† obstacles[currentIndex] t·ªìn t·∫°i
            if (currentIndex < questions.length && obstacles[currentIndex] && obstacles[currentIndex].cleared && !isMoving && !isJumping) {
                 currentIndex++;
                if (currentIndex < questions.length) {
                    speakQuestion();
                } else {
                    questionArea.textContent = "üéâ B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c ch∆∞·ªõng ng·∫°i v·∫≠t!";
                    targetSentenceArea.style.display = 'none';
                    transcriptDiv.textContent = "";
                    feedbackDiv.style.display = 'none';
                    disableButtonsOnComplete();
                    displayResults();
                }
            } else if (currentIndex < questions.length && obstacles[currentIndex] && (!obstacles[currentIndex].cleared || isMoving || isJumping)) {
                 // N·∫øu ch∆∞a v∆∞·ª£t qua ch∆∞·ªõng ng·∫°i v·∫≠t ho·∫∑c hi·ªáu ·ª©ng ƒëang ch·∫°y
                 feedbackDiv.textContent = "B·∫°n c·∫ßn tr·∫£ l·ªùi ƒë√∫ng c√¢u h·ªèi hi·ªán t·∫°i v√† ƒë·ª£i hi·ªáu ·ª©ng k·∫øt th√∫c ƒë·ªÉ chuy·ªÉn sang ch∆∞·ªõng ng·∫°i v·∫≠t ti·∫øp theo!";
                 feedbackDiv.style.display = 'block';
                 feedbackDiv.style.backgroundColor = '#fff3cd'; // M√†u v√†ng nh·∫°t
                 feedbackDiv.style.borderColor = '#ffeeba';
                 speakText("B·∫°n c·∫ßn tr·∫£ l·ªùi ƒë√∫ng c√¢u h·ªèi hi·ªán t·∫°i v√† ƒë·ª£i hi·ªáu ·ª©ng k·∫øt th√∫c ƒë·ªÉ chuy·ªÉn sang ch∆∞·ªõng ng·∫°i v·∫≠t ti·∫øp theo!", 'vi-VN');
            } else if (currentIndex >= questions.length) {
                 // ƒê√£ ·ªü c√¢u cu·ªëi c√πng ho·∫∑c ƒë√£ ho√†n th√†nh
                 questionArea.textContent = "üéâ B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c ch∆∞·ªõng ng·∫°i v·∫≠t!";
                 targetSentenceArea.style.display = 'none';
                 transcriptDiv.textContent = "";
                 feedbackDiv.style.display = 'none';
                 disableButtonsOnComplete();
                 displayResults();
            } else {
                 // Tr∆∞·ªùng h·ª£p kh√°c (v√≠ d·ª•: obstacles[currentIndex] kh√¥ng t·ªìn t·∫°i)
                 console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ch∆∞·ªõng ng·∫°i v·∫≠t cho c√¢u h·ªèi hi·ªán t·∫°i.");
                 feedbackDiv.textContent = "ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng t·∫£i l·∫°i trang.";
                 feedbackDiv.style.display = 'block';
                 feedbackDiv.style.backgroundColor = '#f8d7da';
                 feedbackDiv.style.borderColor = '#f5c6cb';
            }
        }


        function disableButtonsOnComplete() {
            startButton.disabled = true;
            answerButton.disabled = true;
            nextButton.disabled = true;
        }

        function displayResults() {
            resultsDisplayArea.innerHTML = '';

            let resultHTML = "<h3>B·∫£ng K·∫øt Qu·∫£ Luy·ªán N√≥i</h3>";
            const list = questions.map((q, i) => {
                const userAnswer = studentAnswers[i] || "(ch∆∞a tr·∫£ l·ªùi)";
                let correctness = "";
                // Ki·ªÉm tra obstacles[i] tr∆∞·ªõc khi truy c·∫≠p .cleared
                let obstacleStatus = obstacles[i] ? (obstacles[i].cleared ? "‚úÖ ƒê√£ v∆∞·ª£t qua" : "‚ùå Ch∆∞a v∆∞·ª£t qua") : "N/A";


                if (q.correctAnswer) {
                    const normalize = (text) => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, "").replace(/\s+/g, ' ').trim();
                    const normalizedUserAnswer = normalize(userAnswer);
                    const normalizedCorrectAnswer = normalize(q.correctAnswer);

                    if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)" && normalizedUserAnswer === normalizedCorrectAnswer) {
                        correctness = " <span style='color: green; font-weight:bold;'>(R·∫•t t·ªët!)</span>";
                    } else if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)") {
                        correctness = ` <span style='color: red; font-weight:bold;'>(C·∫ßn xem l·∫°i)</span> - ƒê√°p √°n ƒë√∫ng: <em>"${q.correctAnswer}"</em>`;
                    } else {
                        correctness = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                    }
                } else if (userAnswer === "(ch∆∞a tr·∫£ l·ªùi)") {
                        correctness = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                } else {
                     // C√¢u kh√¥ng c√≥ ƒë√°p √°n c·ª• th·ªÉ nh∆∞ng ƒë√£ tr·∫£ l·ªùi
                     correctness = " <span style='color: green; font-weight:bold;'>(ƒê√£ ghi nh·∫≠n)</span>";
                }


                return `<p><strong>Ch∆∞·ªõng ng·∫°i v·∫≠t ${i + 1}:</strong> ${q.question}<br/>
                            <em>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</em> ${userAnswer}${correctness} <br/>
                            <em>Tr·∫°ng th√°i:</em> ${obstacleStatus}</p>`;
            }).join('');

            resultHTML += list;
            resultHTML += `<button onclick="shareGeneratedResults()">üì§ Chia s·∫ª k·∫øt qu·∫£ n√†y</button>`;
            resultHTML += `<div id="copyFeedback" style="display:none;"></div>`;

            resultsDisplayArea.innerHTML = resultHTML;
            resultsDisplayArea.style.display = 'block';
            resultsDisplayArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function shareGeneratedResults() {
            const listItems = questions.map((q, i) => {
                const userAnswer = studentAnswers[i] || "(ch∆∞a tr·∫£ l·ªùi)";
                let correctnessInfo = "";
                 // Ki·ªÉm tra obstacles[i] tr∆∞·ªõc khi truy c·∫≠p .cleared
                let obstacleStatus = obstacles[i] ? (obstacles[i].cleared ? "ƒê√£ v∆∞·ª£t qua" : "Ch∆∞a v∆∞·ª£t qua") : "N/A";


                    if (q.correctAnswer) {
                        const normalize = (text) => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, "").replace(/\s+/g, ' ').trim();
                        const normalizedUserAnswer = normalize(userAnswer);
                        const normalizedCorrectAnswer = normalize(q.correctAnswer);
                        if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)" && normalizedUserAnswer === normalizedCorrectAnswer) {
                            correctnessInfo = " <span style='color: green; font-weight:bold;'>(R·∫•t t·ªët!)</span>";
                        } else if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)") {
                            correctnessInfo = ` <span style='color: red; font-weight:bold;'>(C·∫ßn xem l·∫°i)</span> - ƒê√°p √°n ƒë√∫ng: <em>"${q.correctAnswer}"</em>`;
                        } else {
                            correctnessInfo = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                        }
                    } else if (userAnswer === "(ch∆∞a tr·∫£ l·ªùi)") {
                            correctnessInfo = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                    } else {
                         correctnessInfo = " <span style='color: green; font-weight:bold;'>(ƒê√£ ghi nh·∫≠n)</span>";
                    }


                return `
                    <div style="margin-bottom: 15px; padding-bottom:10px; border-bottom: 1px solid #eee;">
                        <p style="font-weight: bold; color: #0056b3; margin-bottom: 5px;">Ch∆∞·ªõng ng·∫°i v·∫≠t ${i + 1}: ${q.question}</p>
                         <p style="margin-top:5px;"><em>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</em> ${userAnswer}${correctnessInfo}</p>
                        <p style="margin-top:5px;"><em>Tr·∫°ng th√°i:</em> ${obstacleStatus}</p>
                    </div>`;
            }).join('');

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="vi">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>K·∫øt qu·∫£ Luy·ªán N√≥i Ti·∫øng Anh c·ªßa B√©</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; line-height: 1.6; }
                        .container-result { max-width: 700px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                        h2 { color: #0056b3; text-align: center; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 25px; }
                        p { margin-bottom: 8px; }
                        em { font-style: italic; color: #555; }
                    </style>
                </head>
                <body>
                    <div class="container-result">
                        <h2>K·∫øt qu·∫£ Luy·ªán N√≥i Ti·∫øng Anh - V∆∞·ª£t Ch∆∞·ªõng Ng·∫°i V·∫≠t</h2>
                        ${listItems}
                        <p style="text-align:center; margin-top:25px; font-size:0.9em; color: #777;">K·∫øt qu·∫£ ƒë∆∞·ª£c t·∫°o v√†o l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
                    </div>
                </body>
                </html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const copyFeedbackDiv = document.getElementById("copyFeedback");
            copyFeedbackDiv.style.display = 'block';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    copyFeedbackDiv.innerHTML = `üîó Link k·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c sao ch√©p! B·∫°n c√≥ th·ªÉ d√°n (Ctrl+V ho·∫∑c Command+V) ƒë·ªÉ chia s·∫ª. Ho·∫∑c <a href="${url}" target="_blank" rel="noopener noreferrer">xem k·∫øt qu·∫£ t·∫°i ƒë√¢y</a>.`;
                }).catch(err => {
                    console.error('Kh√¥ng th·ªÉ sao ch√©p link t·ª± ƒë·ªông: ', err);
                    copyFeedbackDiv.innerHTML = `Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p link. Vui l√≤ng sao ch√©p th·ªß c√¥ng: <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
                });
            } else {
                copyFeedbackDiv.innerHTML = `Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng sao ch√©p link sau ƒë·ªÉ chia s·∫ª: <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            }
             window.open(url, '_blank');
        }

        // --- Initialization ---
        function initGame() {
            totalObstaclesSpan.textContent = questions.length; // C·∫≠p nh·∫≠t t·ªïng s·ªë ch∆∞·ªõng ng·∫°i v·∫≠t ·ªü ƒë√¢y
            resizeCanvas(); // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas ban ƒë·∫ßu v√† v·ªã tr√≠ ban ƒë·∫ßu c·ªßa playerY, v√† g·ªçi initializeObstacles()
            // Kh·ªüi t·∫°o Tone.js synthesizer
            // S·ª≠ d·ª•ng m·ªôt b·ªô t·ªïng h·ª£p kh√°c v√† ph√°t 2 n·ªët ng·∫Øn ƒë·ªÉ t·∫°o √¢m thanh nh·∫£y
            jumpSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: {
                    type: "triangle" // S·ª≠ d·ª•ng s√≥ng tam gi√°c
                },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.05,
                    release: 0.1
                }
            }).toDestination();

            gameLoop(); // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p game
            // speakQuestion(); // B·ªè comment n·∫øu mu·ªën t·ª± ƒë·ªông b·∫Øt ƒë·∫ßu
        }

        // B·∫Øt ƒë·∫ßu game khi trang t·∫£i xong
        window.onload = initGame;

    </script>
</body>
</html>
